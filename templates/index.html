<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{.Title}} - Vitrari</title>

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <link
            rel="icon"
            type="image/svg+xml"
            href="/static/assets/favicon.svg"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/static/assets/apple-touch-icon.png"
        />

        <link rel="stylesheet" href="/static/css/style.css" />
        <link rel="stylesheet" href="/static/css/mobile.css" />
    </head>
    <body>
        <div class="container">
            <header class="header">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <div>
                        <h1>
                            <a
                                href="/"
                                style="
                                    display: flex;
                                    align-items: center;
                                    text-decoration: none;
                                    color: inherit;
                                "
                            >
                                <img
                                    src="/static/assets/logo.png"
                                    alt="Vitrari Logo"
                                    width="32"
                                    height="32"
                                    style="margin-right: 8px"
                                />
                                Vitrari
                            </a>
                        </h1>
                        <nav>
                            <a
                                href="/"
                                class="active"
                                data-i18n="dashboard"
                                >Dashboard</a
                            >
                            <a href="/design" data-i18n="designer">Designer</a>
                            <a href="/optimize" data-i18n="optimizer"
                                >Optimizer</a
                            >
                        </nav>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px">
                        <div class="language-selector">
                            <button class="lang-btn" data-lang="en">EN</button>
                            <button class="lang-btn active" data-lang="es">
                                ES
                            </button>
                        </div>

                        <!-- User Menu -->
                        {{if .User}}
                        <div class="user-menu" style="position: relative">
                            <button
                                class="user-menu-trigger"
                                onclick="toggleUserMenu()"
                                aria-expanded="false"
                                aria-haspopup="true"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    background: none;
                                    border: none;
                                    color: inherit;
                                    cursor: pointer;
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    transition: background-color 0.2s;
                                "
                            >
                                <svg
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    viewBox="0 0 16 16"
                                >
                                    <path
                                        d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                    />
                                </svg>
                                <span class="user-name"
                                    >{{.User.FirstName}}</span
                                >
                                <svg
                                    width="12"
                                    height="12"
                                    fill="currentColor"
                                    class="dropdown-chevron"
                                    viewBox="0 0 16 16"
                                    style="transition: transform 0.2s"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"
                                    />
                                </svg>
                            </button>
                            <div
                                class="user-dropdown-menu"
                                id="userDropdownMenu"
                                style="
                                    position: absolute;
                                    top: calc(100% + 4px);
                                    right: 0;
                                    min-width: 280px;
                                    background: white;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 8px;
                                    box-shadow: 0 10px 15px -3px
                                        rgba(0, 0, 0, 0.1);
                                    z-index: 1000;
                                    opacity: 0;
                                    visibility: hidden;
                                    transform: translateY(-8px);
                                    transition: all 0.15s ease-in-out;
                                "
                            >
                                <div
                                    class="user-info"
                                    style="
                                        padding: 16px;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    "
                                >
                                    <div
                                        class="user-avatar"
                                        style="
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50%;
                                            background: #42a5f5;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            flex-shrink: 0;
                                        "
                                    >
                                        <svg
                                            width="24"
                                            height="24"
                                            fill="currentColor"
                                            viewBox="0 0 16 16"
                                        >
                                            <path
                                                d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                            />
                                        </svg>
                                    </div>
                                    <div
                                        class="user-details"
                                        style="flex: 1; min-width: 0"
                                    >
                                        <div
                                            class="user-full-name"
                                            style="
                                                font-weight: 500;
                                                color: #212121;
                                                margin-bottom: 2px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            "
                                        >
                                            {{.User.FirstName}}
                                            {{.User.LastName}}
                                        </div>
                                        <div
                                            class="user-email"
                                            style="
                                                font-size: 14px;
                                                color: #757575;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            "
                                        >
                                            {{.User.Email}}
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="dropdown-divider"
                                    style="
                                        height: 1px;
                                        background: #e0e0e0;
                                        margin: 0;
                                    "
                                ></div>
                                <a
                                    href="/profile"
                                    class="dropdown-item"
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 16px;
                                        color: #212121;
                                        text-decoration: none;
                                        transition: background-color 0.15s;
                                        border: none;
                                        background: none;
                                        width: 100%;
                                        text-align: left;
                                        cursor: pointer;
                                        font-size: 14px;
                                    "
                                >
                                    <svg
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                        viewBox="0 0 16 16"
                                        style="flex-shrink: 0; opacity: 0.7"
                                    >
                                        <path
                                            d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                        />
                                    </svg>
                                    Profile
                                </a>
                                <div
                                    class="dropdown-divider"
                                    style="
                                        height: 1px;
                                        background: #e0e0e0;
                                        margin: 0;
                                    "
                                ></div>
                                <button
                                    class="dropdown-item logout-btn"
                                    onclick="handleLogout()"
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 16px;
                                        color: #f44336;
                                        text-decoration: none;
                                        transition: background-color 0.15s;
                                        border: none;
                                        background: none;
                                        width: 100%;
                                        text-align: left;
                                        cursor: pointer;
                                        font-size: 14px;
                                    "
                                >
                                    <svg
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                        viewBox="0 0 16 16"
                                        style="flex-shrink: 0; opacity: 0.7"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"
                                        />
                                        <path
                                            fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                                        />
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>
                        {{else}}
                        <div class="auth-actions">
                            <a
                                href="/auth"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    background: none;
                                    border: none;
                                    color: inherit;
                                    cursor: pointer;
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    transition: background-color 0.2s;
                                    text-decoration: none;
                                "
                            >
                                <svg
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    viewBox="0 0 16 16"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"
                                    />
                                    <path
                                        fill-rule="evenodd"
                                        d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                                    />
                                </svg>
                                Login
                            </a>
                        </div>
                        {{end}}
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="welcome-section">
                    <h2 data-i18n="welcomeTitle">Welcome to Vitrari</h2>
                    <p data-i18n="welcomeDescription">
                        Design custom glass pieces and optimize cutting patterns
                        for maximum efficiency
                    </p>
                </div>

                <div class="quick-actions">
                    <a href="/design" class="action-card">
                        <h3 data-i18n="glassDesigner">Glass Designer</h3>
                        <p data-i18n="designerDescription">
                            Create custom glass designs with precise
                            measurements
                        </p>
                        <button
                            class="btn btn-primary"
                            data-i18n="startDesigning"
                        >
                            Start Designing
                        </button>
                    </a>

                    <a href="/optimize" class="action-card">
                        <h3 data-i18n="sheetOptimizer">Sheet Optimizer</h3>
                        <p data-i18n="optimizerDescription">
                            Optimize cutting patterns to minimize waste
                        </p>
                        <button
                            class="btn btn-outline"
                            data-i18n="optimizeLayout"
                        >
                            Optimize Layout
                        </button>
                    </a>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4 data-i18n="totalDesigns">Total Designs</h4>
                        <div class="stat-value" id="total-designs">0</div>
                    </div>
                    <div class="stat-card">
                        <h4 data-i18n="optimizationsRun">Optimizations Run</h4>
                        <div class="stat-value" id="total-optimizations">0</div>
                    </div>
                    <div class="stat-card">
                        <h4 data-i18n="activeProjects">Active Projects</h4>
                        <div class="stat-value" id="total-projects">0</div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div class="projects-section">
                    <div class="section-header">
                        <h2 data-i18n="projects">Projects</h2>
                        <button class="btn btn-primary" id="btn-new-project">
                            <span class="btn-icon">+</span>
                            <span data-i18n="newProject">New Project</span>
                        </button>
                    </div>

                    <!-- Projects Tree View -->
                    <div class="projects-tree" id="projects-tree">
                        <div class="tree-loading" data-i18n="loadingProjects">
                            Loading projects...
                        </div>
                    </div>
                </div>
            </main>

            <!-- Create/Edit Project Modal -->
            <div class="modal" id="project-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title" data-i18n="newProject">
                            New Project
                        </h3>
                        <button class="modal-close" id="modal-close">
                            &times;
                        </button>
                    </div>
                    <form id="project-form">
                        <input type="hidden" id="project-id" value="" />
                        <input type="hidden" id="project-parent-id" value="" />

                        <div class="form-group">
                            <label for="project-name">
                                <span data-i18n="projectName"
                                    >Project Name</span
                                >
                                *
                            </label>
                            <input
                                type="text"
                                id="project-name"
                                required
                                maxlength="255"
                                data-i18n-placeholder="projectNamePlaceholder"
                                placeholder="Enter project name"
                            />
                        </div>

                        <div class="form-group">
                            <label
                                for="project-description"
                                data-i18n="description"
                            >
                                Description
                            </label>
                            <textarea
                                id="project-description"
                                rows="3"
                                maxlength="1000"
                                data-i18n-placeholder="projectDescriptionPlaceholder"
                                placeholder="Enter project description (optional)"
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label>
                                <span data-i18n="designs">Designs</span>
                                <span
                                    style="color: #64748b; font-weight: normal"
                                    data-i18n="optional"
                                    >(Optional)</span
                                >
                            </label>
                            <div id="designs-list-container">
                                <div
                                    class="designs-placeholder"
                                    data-i18n="noDesignsAdded"
                                >
                                    No designs added. Projects can be empty
                                    (like folders). Click "Add Design" if you
                                    want to include designs.
                                </div>
                            </div>
                            <button
                                type="button"
                                class="btn btn-outline btn-sm"
                                id="btn-add-design"
                            >
                                <span class="btn-icon">+</span>
                                <span data-i18n="addDesign">Add Design</span>
                            </button>
                        </div>

                        <div class="modal-actions">
                            <button
                                type="button"
                                class="btn btn-outline"
                                id="btn-cancel"
                                data-i18n="cancel"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                class="btn btn-primary"
                                id="btn-save-project"
                                data-i18n="saveProject"
                            >
                                Save Project
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Design Picker Modal -->
            <div class="modal" id="design-picker-modal">
                <div class="modal-content modal-sm">
                    <div class="modal-header">
                        <h3 data-i18n="selectDesign">Select Design</h3>
                        <button class="modal-close" id="design-picker-close">
                            &times;
                        </button>
                    </div>
                    <div id="design-picker-list" class="picker-list">
                        <div class="picker-loading" data-i18n="loadingDesigns">
                            Loading designs...
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <p>&copy; 2025 Vitrari - v1.0.0</p>
            </footer>
        </div>

        <script src="/static/js/i18n.js"></script>
        <script src="/static/js/mobile.js"></script>
        <script src="/static/js/app.js"></script>
        <script src="/static/js/toast.js"></script>
        <script src="/static/js/projects.js"></script>
        <script>
            // Load dashboard stats
            fetch("/api/designs")
                .then((r) => r.json())
                .then((data) => {
                    document.getElementById("total-designs").textContent =
                        data.total || 0;
                })
                .catch(console.error);

            fetch("/api/optimizations")
                .then((r) => r.json())
                .then((data) => {
                    document.getElementById("total-optimizations").textContent =
                        data.total || 0;
                })
                .catch(console.error);

            fetch("/api/projects")
                .then((r) => r.json())
                .then((data) => {
                    document.getElementById("total-projects").textContent =
                        data.total || 0;
                })
                .catch(console.error);

            // Update placeholders when language changes
            function updatePlaceholders() {
                document
                    .querySelectorAll("[data-i18n-placeholder]")
                    .forEach((el) => {
                        const key = el.dataset.i18nPlaceholder;
                        if (key && window.i18n) {
                            el.placeholder = window.i18n.t(key);
                        }
                    });
            }

            // Listen for language changes
            document.addEventListener("DOMContentLoaded", () => {
                // Initial update
                setTimeout(updatePlaceholders, 100);

                // Listen for language button clicks
                document.querySelectorAll(".lang-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        setTimeout(updatePlaceholders, 100);
                    });
                });
            });

            // User menu dropdown functions
            function toggleUserMenu() {
                const trigger = document.querySelector(".user-menu-trigger");
                const menu = document.getElementById("userDropdownMenu");

                if (!trigger || !menu) return;

                const isOpen = trigger.getAttribute("aria-expanded") === "true";

                if (isOpen) {
                    closeUserMenu();
                } else {
                    openUserMenu();
                }
            }

            function openUserMenu() {
                const trigger = document.querySelector(".user-menu-trigger");
                const menu = document.getElementById("userDropdownMenu");

                if (!trigger || !menu) return;

                trigger.setAttribute("aria-expanded", "true");
                menu.style.opacity = "1";
                menu.style.visibility = "visible";
                menu.style.transform = "translateY(0)";

                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener(
                        "click",
                        closeUserMenuOnOutsideClick,
                    );
                }, 10);
            }

            function closeUserMenu() {
                const trigger = document.querySelector(".user-menu-trigger");
                const menu = document.getElementById("userDropdownMenu");

                if (!trigger || !menu) return;

                trigger.setAttribute("aria-expanded", "false");
                menu.style.opacity = "0";
                menu.style.visibility = "hidden";
                menu.style.transform = "translateY(-8px)";

                document.removeEventListener(
                    "click",
                    closeUserMenuOnOutsideClick,
                );
            }

            function closeUserMenuOnOutsideClick(event) {
                const userMenu = document.querySelector(".user-menu");

                if (!userMenu || userMenu.contains(event.target)) {
                    return;
                }

                closeUserMenu();
            }

            // Logout function
            async function handleLogout() {
                try {
                    // Close user menu first
                    closeUserMenu();

                    const response = await fetch("/api/auth/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        credentials: "include",
                    });

                    if (response.ok) {
                        // Show success message
                        showSimpleNotification(
                            "Logged out successfully",
                            "success",
                        );

                        // Redirect to auth page after a short delay
                        setTimeout(() => {
                            window.location.href = "/auth";
                        }, 1000);
                    } else {
                        throw new Error("Logout failed");
                    }
                } catch (error) {
                    console.error("Logout error:", error);
                    showSimpleNotification(
                        "Failed to logout. Please try again.",
                        "error",
                    );
                }
            }

            // Simple notification function
            function showSimpleNotification(message, type) {
                const notification = document.createElement("div");
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 6px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    background-color: ${type === "success" ? "#4caf50" : "#f44336"};
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                // Show notification
                setTimeout(() => {
                    notification.style.opacity = "1";
                    notification.style.transform = "translateX(0)";
                }, 10);

                // Hide notification after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = "0";
                    notification.style.transform = "translateX(100%)";
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Close user menu on escape key
            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") {
                    closeUserMenu();
                }
            });

            // Add hover effects with CSS-in-JS
            document.addEventListener("DOMContentLoaded", function () {
                // User menu trigger hover
                const trigger = document.querySelector(".user-menu-trigger");
                if (trigger) {
                    trigger.addEventListener("mouseenter", function () {
                        this.style.backgroundColor = "rgba(0,0,0,0.1)";
                    });
                    trigger.addEventListener("mouseleave", function () {
                        this.style.backgroundColor = "transparent";
                    });
                }

                // Dropdown items hover
                document.querySelectorAll(".dropdown-item").forEach((item) => {
                    item.addEventListener("mouseenter", function () {
                        if (this.classList.contains("logout-btn")) {
                            this.style.backgroundColor =
                                "rgba(244, 67, 54, 0.08)";
                        } else {
                            this.style.backgroundColor = "#f5f5f5";
                        }
                    });
                    item.addEventListener("mouseleave", function () {
                        this.style.backgroundColor = "transparent";
                    });
                });
            });
        </script>
    </body>
</html>
