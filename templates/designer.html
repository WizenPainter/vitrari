<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{.Title}} - Vitrari</title>

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <link
            rel="icon"
            type="image/svg+xml"
            href="/static/assets/favicon.svg"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/static/assets/apple-touch-icon.png"
        />

        <link rel="stylesheet" href="/static/css/style.css" />
        <link rel="stylesheet" href="/static/css/mobile.css" />
    </head>
    <body>
        <div class="container">
            <header class="header">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <div>
                        <h1>Vitrari</h1>
                        <nav>
                            <a href="/" data-i18n="dashboard">Dashboard</a>
                            <a
                                href="/designer"
                                class="active"
                                data-i18n="designer"
                                >Designer</a
                            >
                            <a href="/optimizer" data-i18n="optimizer"
                                >Optimizer</a
                            >
                        </nav>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px">
                        <div class="language-selector">
                            <button class="lang-btn" data-lang="en">EN</button>
                            <button class="lang-btn active" data-lang="es">
                                ES
                            </button>
                        </div>

                        <!-- User Menu -->
                        {{if .User}}
                        <div class="user-menu" style="position: relative">
                            <button
                                class="user-menu-trigger"
                                onclick="toggleUserMenu()"
                                aria-expanded="false"
                                aria-haspopup="true"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    background: none;
                                    border: none;
                                    color: inherit;
                                    cursor: pointer;
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    transition: background-color 0.2s;
                                "
                            >
                                <svg
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    viewBox="0 0 16 16"
                                >
                                    <path
                                        d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                    />
                                </svg>
                                <span class="user-name"
                                    >{{.User.FirstName}}</span
                                >
                                <svg
                                    width="12"
                                    height="12"
                                    fill="currentColor"
                                    class="dropdown-chevron"
                                    viewBox="0 0 16 16"
                                    style="transition: transform 0.2s"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"
                                    />
                                </svg>
                            </button>
                            <div
                                class="user-dropdown-menu"
                                id="userDropdownMenu"
                                style="
                                    position: absolute;
                                    top: calc(100% + 4px);
                                    right: 0;
                                    min-width: 280px;
                                    background: white;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 8px;
                                    box-shadow: 0 10px 15px -3px
                                        rgba(0, 0, 0, 0.1);
                                    z-index: 1000;
                                    opacity: 0;
                                    visibility: hidden;
                                    transform: translateY(-8px);
                                    transition: all 0.15s ease-in-out;
                                "
                            >
                                <div
                                    class="user-info"
                                    style="
                                        padding: 16px;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    "
                                >
                                    <div
                                        class="user-avatar"
                                        style="
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50%;
                                            background: #42a5f5;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            flex-shrink: 0;
                                        "
                                    >
                                        <svg
                                            width="24"
                                            height="24"
                                            fill="currentColor"
                                            viewBox="0 0 16 16"
                                        >
                                            <path
                                                d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                            />
                                        </svg>
                                    </div>
                                    <div
                                        class="user-details"
                                        style="flex: 1; min-width: 0"
                                    >
                                        <div
                                            class="user-full-name"
                                            style="
                                                font-weight: 500;
                                                color: #212121;
                                                margin-bottom: 2px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            "
                                        >
                                            {{.User.FirstName}}
                                            {{.User.LastName}}
                                        </div>
                                        <div
                                            class="user-email"
                                            style="
                                                font-size: 14px;
                                                color: #757575;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            "
                                        >
                                            {{.User.Email}}
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="dropdown-divider"
                                    style="
                                        height: 1px;
                                        background: #e0e0e0;
                                        margin: 0;
                                    "
                                ></div>
                                <a
                                    href="/profile"
                                    class="dropdown-item"
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 16px;
                                        color: #212121;
                                        text-decoration: none;
                                        transition: background-color 0.15s;
                                        border: none;
                                        background: none;
                                        width: 100%;
                                        text-align: left;
                                        cursor: pointer;
                                        font-size: 14px;
                                    "
                                >
                                    <svg
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                        viewBox="0 0 16 16"
                                        style="flex-shrink: 0; opacity: 0.7"
                                    >
                                        <path
                                            d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"
                                        />
                                    </svg>
                                    Profile
                                </a>
                                <div
                                    class="dropdown-divider"
                                    style="
                                        height: 1px;
                                        background: #e0e0e0;
                                        margin: 0;
                                    "
                                ></div>
                                <button
                                    class="dropdown-item logout-btn"
                                    onclick="handleLogout()"
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        padding: 8px 16px;
                                        color: #f44336;
                                        text-decoration: none;
                                        transition: background-color 0.15s;
                                        border: none;
                                        background: none;
                                        width: 100%;
                                        text-align: left;
                                        cursor: pointer;
                                        font-size: 14px;
                                    "
                                >
                                    <svg
                                        width="16"
                                        height="16"
                                        fill="currentColor"
                                        viewBox="0 0 16 16"
                                        style="flex-shrink: 0; opacity: 0.7"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"
                                        />
                                        <path
                                            fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                                        />
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>
                        {{else}}
                        <div class="auth-actions">
                            <a
                                href="/auth"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    background: none;
                                    border: none;
                                    color: inherit;
                                    cursor: pointer;
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    transition: background-color 0.2s;
                                    text-decoration: none;
                                "
                            >
                                <svg
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    viewBox="0 0 16 16"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"
                                    />
                                    <path
                                        fill-rule="evenodd"
                                        d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
                                    />
                                </svg>
                                Login
                            </a>
                        </div>
                        {{end}}
                    </div>
                </div>
            </header>

            <main class="designer-layout">
                <aside class="sidebar">
                    <div
                        class="mobile-sidebar-header"
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1rem;
                            border-bottom: 1px solid var(--border);
                            background: var(--surface);
                        "
                    >
                        <h3 data-i18n="tools" style="margin: 0">Tools</h3>
                        <button
                            class="mobile-close-btn"
                            onclick="toggleMobileSidebar()"
                            style="
                                display: none;
                                background: none;
                                border: none;
                                font-size: 1.5rem;
                                cursor: pointer;
                                padding: 0.25rem;
                                min-height: 44px;
                                min-width: 44px;
                            "
                        >
                            ✕
                        </button>
                    </div>
                    <div class="tool-list">
                        <button
                            class="tool-btn active"
                            data-tool="select"
                            data-i18n="select"
                        >
                            Select
                        </button>
                        <button
                            class="tool-btn"
                            data-tool="taladro"
                            data-i18n="taladro"
                        >
                            Drill Hole
                        </button>
                        <button
                            class="tool-btn"
                            data-tool="circle"
                            data-i18n="circleHole"
                        >
                            Circle Hole
                        </button>
                        <button
                            class="tool-btn"
                            data-tool="rectangle"
                            data-i18n="rectangleHole"
                        >
                            Rectangle Hole
                        </button>
                        <button
                            class="tool-btn"
                            data-tool="avellanado"
                            data-i18n="avellanado"
                        >
                            Countersink
                        </button>
                        <button
                            class="tool-btn"
                            data-tool="clip"
                            data-i18n="edgeClip"
                        >
                            Edge Clip
                        </button>
                    </div>

                    <h3 data-i18n="glassProperties">Glass Properties</h3>
                    <div class="properties">
                        <label>
                            <span data-i18n="width">Width</span> (mm):
                            <input
                                type="number"
                                id="glass-width"
                                value="1200"
                            />
                        </label>
                        <label>
                            <span data-i18n="height">Height</span> (mm):
                            <input
                                type="number"
                                id="glass-height"
                                value="800"
                            />
                        </label>
                        <label>
                            <span data-i18n="thickness">Thickness</span> (mm):
                            <select
                                id="glass-thickness-select"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid #cbd5e1;
                                    border-radius: 4px;
                                    margin-top: 0.25rem;
                                "
                            >
                                <option value="4">4</option>
                                <option value="6" selected>6</option>
                                <option value="8">8</option>
                                <option value="9.5">9.5</option>
                                <option value="12">12</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input
                                type="number"
                                id="glass-thickness"
                                value="6"
                                step="0.1"
                                min="0"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid #cbd5e1;
                                    border-radius: 4px;
                                    margin-top: 0.25rem;
                                    display: none;
                                "
                            />
                        </label>
                    </div>

                    <div id="holes-section">
                        <h3 data-i18n="holesList">Holes List</h3>
                        <div id="holes-list" class="holes-list">
                            <p
                                style="
                                    color: #64748b;
                                    font-size: 0.875rem;
                                    font-style: italic;
                                "
                                data-i18n="noHoles"
                            >
                                No holes yet. Click on canvas to add.
                            </p>
                        </div>
                    </div>
                </aside>

                <div class="canvas-area">
                    <div class="canvas-toolbar">
                        <button
                            class="btn btn-primary"
                            id="btn-save-to-project"
                            data-i18n="save"
                        >
                            Save
                        </button>
                        <button
                            class="btn btn-outline"
                            id="btn-save-as"
                            data-i18n="saveAs"
                        >
                            Save As
                        </button>
                        <button
                            class="btn production-only desktop-only"
                            id="btn-save"
                            data-i18n="saveDesign"
                        >
                            Export to File
                        </button>
                        <button
                            class="btn production-only desktop-only"
                            id="btn-load"
                            data-i18n="loadDesign"
                        >
                            Load Design
                        </button>
                        <button
                            class="btn"
                            id="btn-print"
                            data-i18n="printDesign"
                        >
                            Print Design
                        </button>
                        <button class="btn" id="btn-clear" data-i18n="clearAll">
                            Clear All
                        </button>
                    </div>
                    <canvas id="design-canvas"></canvas>
                    <div class="canvas-info">
                        <p>
                            <strong data-i18n="instructions"
                                >Instructions:</strong
                            >
                        </p>
                        <ul style="text-align: left; margin-top: 0.5rem">
                            <li data-i18n="instruction1">
                                Select a tool from the left sidebar
                            </li>
                            <li data-i18n="instruction2">
                                Click and drag on the canvas to create holes
                            </li>
                            <li data-i18n="instruction3">
                                Use the Select tool to move existing holes
                            </li>
                            <li data-i18n="instruction4">
                                Edit hole properties in the sidebar when
                                selected
                            </li>
                            <li data-i18n="instruction5">
                                Press Delete key to remove selected hole
                            </li>
                            <li data-i18n="instruction6">
                                Save your design to a JSON file for later use
                            </li>
                        </ul>
                    </div>
                </div>
            </main>

            <!-- Print Template (hidden on screen, shown when printing) -->
            <div class="print-template" id="print-template">
                <!-- Content will be dynamically generated by JavaScript -->
            </div>

            <!-- Save to Project Modal -->
            <div class="modal" id="save-to-project-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Save Design to Project</h3>
                        <button class="modal-close" id="save-project-close">
                            &times;
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="design-name-input">Design Name *</label>
                            <input
                                type="text"
                                id="design-name-input"
                                placeholder="Enter design name"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="design-description-input"
                                >Description</label
                            >
                            <textarea
                                id="design-description-input"
                                rows="2"
                                placeholder="Optional description"
                            ></textarea>
                        </div>
                        <div class="form-group">
                            <label
                                >Select Project (Optional - leave unselected for
                                no project)</label
                            >
                            <div
                                id="project-tree-selector"
                                class="project-tree-selector"
                            >
                                <div class="tree-loading">
                                    Loading projects...
                                </div>
                            </div>
                        </div>
                        <div
                            id="selected-project-path"
                            class="selected-project-path"
                            style="display: none"
                        >
                            <strong>Selected:</strong>
                            <span id="selected-path-text"></span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button
                            type="button"
                            class="btn btn-outline"
                            id="btn-cancel-save"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            id="btn-confirm-save"
                        >
                            Save Design
                        </button>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <p>&copy; 2025 Vitrari - v1.0.0</p>
            </footer>
        </div>

        <!-- Mobile sidebar toggle button -->
        <button
            id="mobile-sidebar-toggle"
            class="mobile-sidebar-toggle"
            onclick="toggleMobileSidebar()"
            style="
                display: none;
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 50%;
                width: 56px;
                height: 56px;
                font-size: 1.25rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                cursor: pointer;
            "
        >
            🔧
        </button>

        <script src="/static/js/i18n.js"></script>
        <script src="/static/js/mobile.js"></script>
        <script src="/static/js/app.js"></script>
        <script src="/static/js/designer.js"></script>
        <script>
            // Check production environment and hide/show elements accordingly
            function initializeEnvironment() {
                const isProduction =
                    window.location.hostname !== "localhost" &&
                    window.location.hostname !== "127.0.0.1" &&
                    !window.location.hostname.includes("local") &&
                    !window.location.port;

                const productionOnlyElements =
                    document.querySelectorAll(".production-only");
                productionOnlyElements.forEach((element) => {
                    if (!isProduction) {
                        element.style.display = "none";
                    }
                });
            }

            // Handle mobile-specific UI adjustments
            function handleMobileView() {
                const desktopOnlyElements =
                    document.querySelectorAll(".desktop-only");
                if (window.innerWidth <= 768) {
                    desktopOnlyElements.forEach((element) => {
                        element.style.display = "none";
                    });
                } else {
                    desktopOnlyElements.forEach((element) => {
                        element.style.display = "";
                    });
                }
            }

            function toggleMobileSidebar() {
                const sidebar = document.querySelector(".sidebar");
                const toggle = document.getElementById("mobile-sidebar-toggle");
                const closeBtn = document.querySelector(".mobile-close-btn");

                if (window.innerWidth <= 768) {
                    const isVisible = sidebar.classList.contains("mobile-open");

                    if (isVisible) {
                        sidebar.classList.remove("mobile-open");
                        sidebar.style.transform = "translateY(100%)";
                        toggle.style.display = "block";
                        closeBtn.style.display = "none";
                    } else {
                        sidebar.classList.add("mobile-open");
                        sidebar.style.transform = "translateY(0)";
                        sidebar.style.position = "fixed";
                        sidebar.style.bottom = "0";
                        sidebar.style.left = "0";
                        sidebar.style.right = "0";
                        sidebar.style.zIndex = "999";
                        sidebar.style.maxHeight = "70vh";
                        sidebar.style.transition = "transform 0.3s ease";
                        sidebar.style.background = "var(--surface)";
                        sidebar.style.borderTop = "2px solid var(--border)";
                        sidebar.style.boxShadow = "0 -4px 20px rgba(0,0,0,0.3)";
                        toggle.style.display = "none";
                        closeBtn.style.display = "block";
                    }
                }
            }

            // Initialize mobile sidebar state
            function initializeMobile() {
                handleMobileView();
                const sidebar = document.querySelector(".sidebar");
                const toggle = document.getElementById("mobile-sidebar-toggle");
                const closeBtn = document.querySelector(".mobile-close-btn");

                if (window.innerWidth <= 768) {
                    toggle.style.display = "block";
                    sidebar.style.transform = "translateY(100%)";
                    sidebar.style.transition = "transform 0.3s ease";
                    closeBtn.style.display = "none";

                    // Enable touch handling
                    toggle.style.webkitTapHighlightColor = "transparent";
                    toggle.style.userSelect = "none";
                    toggle.style.touchAction = "manipulation";

                    closeBtn.style.webkitTapHighlightColor = "transparent";
                    closeBtn.style.userSelect = "none";
                    closeBtn.style.touchAction = "manipulation";
                } else {
                    toggle.style.display = "none";
                    closeBtn.style.display = "none";
                    sidebar.style.transform = "";
                    sidebar.style.position = "";
                    sidebar.style.bottom = "";
                    sidebar.style.left = "";
                    sidebar.style.right = "";
                    sidebar.style.zIndex = "";
                    sidebar.style.maxHeight = "";
                    sidebar.style.transition = "";
                    sidebar.style.background = "";
                    sidebar.style.borderTop = "";
                    sidebar.style.boxShadow = "";
                    sidebar.classList.remove("mobile-open");
                }
            }

            window.addEventListener("resize", initializeMobile);
            window.addEventListener("load", () => {
                initializeEnvironment();
                initializeMobile();
            });

            // Initialize immediately
            initializeEnvironment();
            initializeMobile();

            // User menu functions
            function toggleUserMenu() {
                const menu = document.getElementById("userDropdownMenu");
                const trigger = document.querySelector(".user-menu-trigger");
                const chevron = document.querySelector(".dropdown-chevron");

                const isOpen = menu.style.opacity === "1";

                if (isOpen) {
                    menu.style.opacity = "0";
                    menu.style.visibility = "hidden";
                    menu.style.transform = "translateY(-8px)";
                    trigger.setAttribute("aria-expanded", "false");
                    chevron.style.transform = "rotate(0deg)";
                } else {
                    menu.style.opacity = "1";
                    menu.style.visibility = "visible";
                    menu.style.transform = "translateY(0)";
                    trigger.setAttribute("aria-expanded", "true");
                    chevron.style.transform = "rotate(180deg)";
                }
            }

            function handleLogout() {
                if (confirm("Are you sure you want to logout?")) {
                    fetch("/api/auth/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then((response) => {
                            if (response.ok) {
                                window.location.href = "/";
                            } else {
                                alert("Logout failed. Please try again.");
                            }
                        })
                        .catch((error) => {
                            console.error("Logout error:", error);
                            alert("Logout failed. Please try again.");
                        });
                }
            }

            // Close dropdown when clicking outside
            document.addEventListener("click", function (event) {
                const userMenu = document.querySelector(".user-menu");
                const dropdown = document.getElementById("userDropdownMenu");

                if (userMenu && !userMenu.contains(event.target)) {
                    if (dropdown) {
                        dropdown.style.opacity = "0";
                        dropdown.style.visibility = "hidden";
                        dropdown.style.transform = "translateY(-8px)";
                        const trigger =
                            document.querySelector(".user-menu-trigger");
                        if (trigger) {
                            trigger.setAttribute("aria-expanded", "false");
                        }
                        const chevron =
                            document.querySelector(".dropdown-chevron");
                        if (chevron) {
                            chevron.style.transform = "rotate(0deg)";
                        }
                    }
                }
            });

            // Language selector functionality
            document.querySelectorAll(".lang-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    document
                        .querySelectorAll(".lang-btn")
                        .forEach((b) => b.classList.remove("active"));
                    this.classList.add("active");

                    const lang = this.dataset.lang;
                    document.documentElement.lang = lang;

                    // Update translations (placeholder for future i18n implementation)
                    console.log("Language changed to:", lang);
                });
            });
        </script>
    </body>
</html>
