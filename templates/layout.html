<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .Title}}{{.Title}} - {{end}}Vitrari</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/main.css">
    {{if .PageCSS}}
    <link rel="stylesheet" href="/static/css/{{.PageCSS}}.css">
    {{end}}

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/assets/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/assets/apple-touch-icon.png">

    <!-- Meta tags -->
    <meta name="description" content="Professional glass design and optimization tool for efficient material usage and waste reduction.">
    <meta name="keywords" content="glass, design, optimization, manufacturing, CAD, cutting">
    <meta name="author" content="Vitrari Team">

    <!-- Open Graph -->
    <meta property="og:title" content="Vitrari">
    <meta property="og:description" content="Design custom glass pieces and optimize cutting patterns">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{.BaseURL}}">

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body class="{{.BodyClass}}">
    <!-- Application Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="flex items-center justify-between">
                <!-- Brand/Logo -->
                <div class="flex items-center gap-lg">
                    <h1 class="nav-brand">
                        <a href="/" class="text-on-primary">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor" class="inline-block mr-2">
                                <!-- Glass icon -->
                                <rect x="4" y="6" width="24" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                                <rect x="6" y="8" width="20" height="12" fill="currentColor" opacity="0.3"/>
                                <circle cx="12" cy="14" r="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                <circle cx="20" cy="14" r="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M4 24L28 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Vitrari
                        </a>
                    </h1>
                </div>

                <!-- Navigation -->
                <nav class="flex items-center main-nav">
                    <ul class="nav-links">
                        <li>
                            <a href="/" class="nav-link {{if eq .Page "home"}}active{{end}}">
                                <svg width="16" height="16" fill="currentColor" class="inline mr-1">
                                    <path d="M8 1l7 7v7a1 1 0 01-1 1H2a1 1 0 01-1-1V8l7-7z"/>
                                </svg>
                                Home
                            </a>
                        </li>
                        <li>
                            <a href="/designer" class="nav-link {{if eq .Page "designer"}}active{{end}}">
                                <svg width="16" height="16" fill="currentColor" class="inline mr-1">
                                    <rect x="2" y="2" width="12" height="12" rx="1"/>
                                    <circle cx="6" cy="6" r="1"/>
                                    <circle cx="10" cy="10" r="1"/>
                                </svg>
                                Designer
                            </a>
                        </li>
                        <li>
                            <a href="/optimizer" class="nav-link {{if eq .Page "optimizer"}}active{{end}}">
                                <svg width="16" height="16" fill="currentColor" class="inline mr-1">
                                    <rect x="1" y="1" width="6" height="4"/>
                                    <rect x="9" y="1" width="6" height="4"/>
                                    <rect x="1" y="7" width="6" height="4"/>
                                    <rect x="9" y="7" width="6" height="4"/>
                                    <rect x="5" y="13" width="6" height="2"/>
                                </svg>
                                Optimizer
                            </a>
                        </li>
                        <li>
                            <a href="/projects" class="nav-link {{if eq .Page "projects"}}active{{end}}">
                                <svg width="16" height="16" fill="currentColor" class="inline mr-1">
                                    <path d="M3 3h10a2 2 0 012 2v8a2 2 0 01-2 2H3a2 2 0 01-2-2V5a2 2 0 012-2z"/>
                                    <path d="M7 1v4"/>
                                    <path d="M11 1v4"/>
                                </svg>
                                Projects
                            </a>
                        </li>
                    </ul>

                    <!-- User Menu / Actions -->
                    <div class="flex items-center gap-sm ml-lg">
                        <!-- Health Status Indicator -->
                        <div class="tooltip" data-tooltip="System Status">
                            <button id="health-indicator" class="btn-ghost btn-sm" onclick="checkSystemHealth()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="8" cy="8" r="6"/>
                                    <circle cx="8" cy="8" r="2" fill="currentColor"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Settings -->
                        <div class="tooltip" data-tooltip="Settings">
                            <button class="btn-ghost btn-sm" onclick="openSettings()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="8" cy="8" r="3"/>
                                    <path d="M8 1v6M8 11v6M1 8h6M11 8h6"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Help -->
                        <div class="tooltip" data-tooltip="Help & Documentation">
                            <button class="btn-ghost btn-sm" onclick="openHelp()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="8" cy="8" r="7"/>
                                    <path d="M6 6a2 2 0 014 0c0 2-2 2-2 3M8 13h.01"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Debug: User context -->
                        <!-- User: {{.User}} -->
                        <!-- User FirstName: {{if .User}}{{.User.FirstName}}{{else}}NO USER{{end}} -->

                        <!-- User Menu -->
                        {{if .User}}
                        <div class="user-menu dropdown">
                            <button class="btn-ghost btn-sm user-menu-trigger" onclick="toggleUserMenu()" aria-expanded="false" aria-haspopup="true">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                </svg>
                                <span class="user-name">{{.User.FirstName}}</span>
                                <svg width="12" height="12" fill="currentColor" class="dropdown-chevron" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                </svg>
                            </button>
                            <div class="user-dropdown-menu" id="userDropdownMenu">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                        </svg>
                                    </div>
                                    <div class="user-details">
                                        <div class="user-full-name">{{.User.FirstName}} {{.User.LastName}}</div>
                                        <div class="user-email">{{.User.Email}}</div>
                                    </div>
                                </div>
                                <div class="dropdown-divider"></div>
                                <a href="/profile" class="dropdown-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                    </svg>
                                    Profile
                                </a>
                                <a href="/settings" class="dropdown-item">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                                    </svg>
                                    Account Settings
                                </a>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item logout-btn" onclick="handleLogout()">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>
                        {{else}}
                        <!-- Debug: No user, showing login -->
                        <div class="auth-actions">
                            <a href="/auth" class="btn-ghost btn-sm">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5 1 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                                    <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                                </svg>
                                Login
                            </a>
                        </div>
                        {{end}}
                    </div>
                </nav>

                <!-- Mobile Menu Toggle will be added by mobile.js -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="app-main">
            {{template "content" .}}
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-md">
                    <span>&copy; 2025 Vitrari</span>
                    <span class="text-hint">|</span>
                    <span id="app-version">v1.0.0</span>
                </div>

                <div class="flex items-center gap-md">
                    <!-- Connection Status -->
                    <div class="flex items-center gap-xs">
                        <div id="connection-status" class="w-2 h-2 rounded-full bg-success"></div>
                        <span class="text-xs">Connected</span>
                    </div>

                    <!-- Performance Stats -->
                    <div class="text-xs text-hint">
                        <span id="memory-usage"></span>
                        <span class="mx-1">•</span>
                        <span id="response-time"></span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Global Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Global Modal Container -->
    <div id="modal-container"></div>

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="shortcuts-modal" class="modal-backdrop" style="display: none;" onclick="closeShortcutsModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeShortcutsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-2 gap-md">
                    <div>
                        <h4>General</h4>
                        <ul class="space-y-xs text-sm">
                            <li><kbd>Ctrl/Cmd + S</kbd> - Save</li>
                            <li><kbd>Ctrl/Cmd + Z</kbd> - Undo</li>
                            <li><kbd>Ctrl/Cmd + Shift + Z</kbd> - Redo</li>
                            <li><kbd>Escape</kbd> - Cancel/Deselect</li>
                            <li><kbd>Delete</kbd> - Delete selected</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Designer</h4>
                        <ul class="space-y-xs text-sm">
                            <li><kbd>Ctrl/Cmd + A</kbd> - Select all</li>
                            <li><kbd>Ctrl/Cmd + C</kbd> - Copy</li>
                            <li><kbd>Ctrl/Cmd + V</kbd> - Paste</li>
                            <li><kbd>+</kbd> / <kbd>-</kbd> - Zoom in/out</li>
                            <li><kbd>Ctrl/Cmd + 0</kbd> - Reset zoom</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeShortcutsModal()">Got it</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-backdrop" style="display: none;" onclick="closeSettingsModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="space-y-lg">
                    <!-- Theme Settings -->
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select class="form-select" id="theme-selector" onchange="changeTheme(this.value)">
                            <option value="auto">Auto (System)</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <!-- Units -->
                    <div class="form-group">
                        <label class="form-label">Default Units</label>
                        <select class="form-select" id="units-selector" onchange="changeUnits(this.value)">
                            <option value="mm">Millimeters (mm)</option>
                            <option value="cm">Centimeters (cm)</option>
                            <option value="inches">Inches</option>
                        </select>
                    </div>

                    <!-- Grid Settings -->
                    <div class="form-group">
                        <label class="form-label">Grid Size</label>
                        <input type="number" class="form-input" id="grid-size" min="5" max="50" value="20">
                        <div class="form-error" id="grid-size-error"></div>
                    </div>

                    <!-- Precision -->
                    <div class="form-group">
                        <label class="form-label">Decimal Precision</label>
                        <select class="form-select" id="precision-selector">
                            <option value="0">0 decimal places</option>
                            <option value="1" selected>1 decimal place</option>
                            <option value="2">2 decimal places</option>
                            <option value="3">3 decimal places</option>
                        </select>
                    </div>

                    <!-- Auto-save -->
                    <div class="form-group">
                        <label class="flex items-center gap-sm">
                            <input type="checkbox" id="auto-save" checked>
                            <span>Auto-save designs</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="resetSettings()">Reset to Defaults</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/htmx.org@1.9.8"></script>

    <!-- Application JavaScript -->
    <script src="/static/js/main.js"></script>
    {{if .PageJS}}
    <script src="/static/js/{{.PageJS}}.js"></script>
    {{end}}

    <!-- Global JavaScript Functions -->
    <script>
        // System health check
        async function checkSystemHealth() {
            try {
                const indicator = document.getElementById('health-indicator');
                indicator.classList.add('loading');

                const response = await fetch('/api/health');
                const health = await response.json();

                if (health.status === 'healthy') {
                    window.glassApp.notificationManager.success('System is healthy');
                } else {
                    window.glassApp.notificationManager.warning('System issues detected');
                }
            } catch (error) {
                window.glassApp.notificationManager.error('Failed to check system health');
            } finally {
                const indicator = document.getElementById('health-indicator');
                indicator.classList.remove('loading');
            }
        }

        // Modal management
        function openShortcutsModal() {
            document.getElementById('shortcuts-modal').style.display = 'flex';
        }

        function closeShortcutsModal() {
            document.getElementById('shortcuts-modal').style.display = 'none';
        }

        function openSettings() {
            loadCurrentSettings();
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function openHelp() {
            openShortcutsModal();
        }

        // Settings management
        function loadCurrentSettings() {
            const settings = JSON.parse(localStorage.getItem('glass-optimizer-settings') || '{}');

            // Load current values
            document.getElementById('theme-selector').value = settings.theme || 'auto';
            document.getElementById('units-selector').value = settings.units || 'mm';
            document.getElementById('grid-size').value = settings.gridSize || 20;
            document.getElementById('precision-selector').value = settings.precision || 1;
            document.getElementById('auto-save').checked = settings.autoSave !== false;
        }

        function saveSettings() {
            const settings = {
                theme: document.getElementById('theme-selector').value,
                units: document.getElementById('units-selector').value,
                gridSize: parseInt(document.getElementById('grid-size').value),
                precision: parseInt(document.getElementById('precision-selector').value),
                autoSave: document.getElementById('auto-save').checked
            };

            localStorage.setItem('glass-optimizer-settings', JSON.stringify(settings));
            applySettings(settings);

            window.glassApp.notificationManager.success('Settings saved successfully');
            closeSettingsModal();
        }

        function resetSettings() {
            localStorage.removeItem('glass-optimizer-settings');
            loadCurrentSettings();
            window.glassApp.notificationManager.info('Settings reset to defaults');
        }

        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Apply grid size if designer is active
            if (window.glassDesigner) {
                window.glassDesigner.options.gridSize = settings.gridSize;
                window.glassDesigner.render();
            }

            // Emit settings change event
            if (window.glassApp) {
                window.glassApp.emit('settings:changed', settings);
            }
        }

        function changeTheme(theme) {
            applySettings({ theme });
        }

        function changeUnits(units) {
            // Update UI units immediately
            window.glassApp.emit('units:changed', units);
        }

        // Mobile menu toggle - handled by mobile.js
        function toggleMobileMenu() {
            if (window.mobileEnhancements) {
                if (window.mobileEnhancements.sidebarOpen) {
                    window.mobileEnhancements.closeMobileMenu();
                } else {
                    window.mobileEnhancements.openMobileMenu();
                }
            }
        }

        // Update performance stats
        function updatePerformanceStats() {
            // Memory usage (if available)
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory-usage').textContent = `${used}MB`;
            }

            // Response time (simplified)
            const responseTime = Math.round(performance.now() % 1000);
            document.getElementById('response-time').textContent = `${responseTime}ms`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings
            const settings = JSON.parse(localStorage.getItem('glass-optimizer-settings') || '{}');
            applySettings(settings);

            // Update performance stats periodically
            setInterval(updatePerformanceStats, 5000);
            updatePerformanceStats();

            // Global keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Help shortcut
                if (e.key === 'F1' || (e.key === '?' && e.shiftKey)) {
                    e.preventDefault();
                    openHelp();
                }

                // Settings shortcut
                if (e.key === ',' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    openSettings();
                }
            });
        });

        // User menu dropdown functions
        function toggleUserMenu() {
            const trigger = document.querySelector('.user-menu-trigger');
            const menu = document.getElementById('userDropdownMenu');

            if (!trigger || !menu) return;

            const isOpen = trigger.getAttribute('aria-expanded') === 'true';

            if (isOpen) {
                closeUserMenu();
            } else {
                openUserMenu();
            }
        }

        function openUserMenu() {
            const trigger = document.querySelector('.user-menu-trigger');
            const menu = document.getElementById('userDropdownMenu');

            if (!trigger || !menu) return;

            trigger.setAttribute('aria-expanded', 'true');
            menu.classList.add('show');

            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeUserMenuOnOutsideClick);
            }, 10);
        }

        function closeUserMenu() {
            const trigger = document.querySelector('.user-menu-trigger');
            const menu = document.getElementById('userDropdownMenu');

            if (!trigger || !menu) return;

            trigger.setAttribute('aria-expanded', 'false');
            menu.classList.remove('show');

            document.removeEventListener('click', closeUserMenuOnOutsideClick);
        }

        function closeUserMenuOnOutsideClick(event) {
            const userMenu = document.querySelector('.user-menu');

            if (!userMenu || userMenu.contains(event.target)) {
                return;
            }

            closeUserMenu();
        }

        // Logout function
        async function handleLogout() {
            try {
                // Close user menu first
                closeUserMenu();

                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    // Show success message
                    if (window.glassApp && window.glassApp.notificationManager) {
                        window.glassApp.notificationManager.success('Logged out successfully');
                    } else {
                        // Fallback notification
                        showSimpleNotification('Logged out successfully', 'success');
                    }

                    // Redirect to auth page after a short delay
                    setTimeout(() => {
                        window.location.href = '/auth';
                    }, 1000);
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);

                // Show error message
                if (window.glassApp && window.glassApp.notificationManager) {
                    window.glassApp.notificationManager.error('Failed to logout. Please try again.');
                } else {
                    showSimpleNotification('Failed to logout. Please try again.', 'error');
                }
            }
        }

        // Simple notification fallback
        function showSimpleNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                background-color: ${type === 'success' ? '#4caf50' : '#f44336'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Enhanced keyboard navigation for user menu
        document.addEventListener('keydown', function(e) {
            const userMenu = document.querySelector('.user-menu');
            const isUserMenuOpen = userMenu && userMenu.querySelector('.user-menu-trigger[aria-expanded="true"]');

            if (e.key === 'Escape') {
                closeUserMenu();
            }

            // Arrow key navigation in user menu
            if (isUserMenuOpen) {
                const menuItems = userMenu.querySelectorAll('.dropdown-item');
                const currentFocus = document.activeElement;
                let currentIndex = Array.from(menuItems).indexOf(currentFocus);

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentIndex = currentIndex < menuItems.length - 1 ? currentIndex + 1 : 0;
                    menuItems[currentIndex].focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentIndex = currentIndex > 0 ? currentIndex - 1 : menuItems.length - 1;
                    menuItems[currentIndex].focus();
                } else if (e.key === 'Enter' && currentFocus.classList.contains('dropdown-item')) {
                    e.preventDefault();
                    currentFocus.click();
                }
            }
        });
    </script>

    {{if .CustomJS}}
    <script>
        {{.CustomJS}}
    </script>
    {{end}}
</body>
</html>
